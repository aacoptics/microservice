<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aacoptics.budget.report.mapper.ProductionCostBudgetMapper">

    <select id="findProductionCostBudgetAllYearByUploadLogId" resultType="integer">
        select distinct year
        from fb_production_cost_budget
        where 1=1
        AND upload_log_id = #{uploadLogId}
        order by year
    </select>

    <select id="findByBusinessDivisionAndProductLine" resultType="com.aacoptics.budget.report.entity.po.ProductionCostBudget">
        select top 1 *
        from fb_production_cost_budget
        where 1=1
        AND business_division = #{businessDivision}
        AND product_line = #{productLine}
        order by item_seq
    </select>


    <select id="findProductionCostBudgetByUploadLogId" resultType="map">
    with temp_year_1 as (
        select *
        from fb_production_cost_budget
        where year = #{firstYear}
          and upload_log_id = #{uploadLogId}),
        temp_year_2 as (
             select *
             from fb_production_cost_budget
             where year = #{secondYear}
               and upload_log_id = #{uploadLogId})
        select
            temp_year_1.business_division businessDivision,
            temp_year_1.product_line productLine,
            temp_year_1.data_version dataVersion,
            temp_year_1.item_seq itemSeq,
            temp_year_1.category_1 category1,
            temp_year_1.category_2 category2,
            temp_year_1.category_3 category3,
            temp_year_1.unit unit,
            temp_year_1.validation validation
            ${selectColumn}
        from temp_year_1
            left join temp_year_2 on temp_year_1.business_division = temp_year_2.business_division
            and temp_year_1.product_line = temp_year_2.product_line
            and temp_year_1.data_version = temp_year_2.data_version
            and temp_year_1.item_seq = temp_year_2.item_seq
        order by temp_year_1.item_seq;
    </select>

</mapper>
